<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' lang='en'>

<head>
    <meta charset='utf-8' />
    <title>Open Booking API 0.5</title>

    <script type="text/javascript" class='remove'>
        var respecConfig = {
            // specification status (e.g. WD, LCWD, NOTE, etc.). If in doubt use ED.
            specStatus: "CG-DRAFT",

            // the specification's short name, as in http://www.w3.org/TR/short-name/
            shortName: "open-booking-api",

            // if you wish the publication date to be other than today, set this
            // publishDate:  "2009-08-06",

            // if there is a previously published draft, uncomment this and set its YYYY-MM-DD date
            // and its maturity status
            // previousPublishDate:  "1977-03-15",
            //previousMaturity: "ED",
            //previousPublishDate: "2018-05-03",

            // if there a publicly available Editor's Draft, this is the link
            edDraftURI: "https://www.openactive.io/open-booking-api/EditorsDraft/",
            //prevED:  "https://www.openactive.io/spec-template/",
            //previousURI:  "https://www.openactive.io/realtime-paged-data-exchange/0.2.3/",
            //testSuiteURI: "https://www.openactive.io/endpoint-validator/",
            copyrightStart: 2018,

            // editors, add as many as you like
            // only "name" is required
            editors: [{
                name: "Leigh Dodds",
                url: "http://ldodds.com",
                company: "Open Data Institute",
                companyURL: "http://theodi.org",
                w3cid: 55359
            }, {
                name: "Nick Evans",
                url: "http://nickevans.me/",
                company: "Open Data Institute",
                companyURL: "http://theodi.org"
            }],

            otherLinks: [{
                key: "Repo",
                value: "We are on Github",
                href: "https://github.com/openactive/open-booking-api/",
                class: "repo"
            }, {
                key: "Issues",
                value: "Report an issue",
                href: "https://github.com/openactive/open-booking-api/issues/"
            }],

            logos: [{
                src: 'https://www.openactive.io/assets/openactive-logo-large.png',
                href: "https://www.openactive.io",
                alt: "openactive.io",
                width: 255, //170
                height: 43, //22
                id: 'logo'
            }],

            // name of the WG
            wg: "OpenActive Community Group",

            // URI of the public WG page
            wgURI: "https://www.w3.org/community/openactive/",

            // name (with the @w3c.org) of the public mailing to which comments are due
            wgPublicList: "public-openactive",

            maxTocLevel: 4,
            preProcess: [],
            noRecTrack: true,
            issueBase: "https://github.com/openactive/open-booking-api/issues/",
            format: "markdown",
            localBiblio: {
                "JSON-LD": {
                    "href": "https://www.w3.org/TR/json-ld/",
                    "title": "JSON-LD 1.0",
                    "status": "REC",
                    "publisher": "W3C",
                },
                "SCHEMA-ORG": {
                    "href": "http://schema.org/",
                    "title": "Schema.org"

                },
                "Modelling-Opportunity-Data": {
                    "href": "https://www.openactive.io/modelling-opportunity-data/",
                    "title": "Modelling Opportunity Data",
                    "publisher": "OpenActive Community Group",
                },
                "RPDE": {
                    "href": "https://www.openactive.io/realtime-paged-data-exchange/",
                    "title": "Realtime Paged Data Exchange",
                    "publisher": "OpenActive Community Group",
                },
                "OpenActive-Vocabulary": {
                    "href": "https://www.openactive.io/ns/",
                    "title": "OpenActive Vocabulary",
                    "publisher": "OpenActive Community Group",
                },
                "OAuth2" : {
                    "href": "https://oauth.net/2/",
                    "title": "OAuth 2.0",
                },
                "OpenIdConnect" : {
                    "href": "http://openid.net/connect/",
                    "title": "OpenID Connect",
                }
            }
        };
    </script>

    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' class='remove'></script>

    <style>
        table {
            border-collapse: collapse;
            border: 1px solid #bec9d9
        }

        td,
        th {
            padding: 3px 0.5em;
            border-left: 1px solid black;
            border-right: 1px solid black;
            border-bottom: 1px solid #E2EDFE;
        }

        tr th[colspan] {
            color: #005A9C;
            background-color: #FEEDE2;
            text-align: center
        }

        th {
            color: #005A9C;
            background-color: #E2EDFE;
            font-weight: normal;
            border-bottom: 1px solid #BEC9D9;
        }

        tbody tr th {
            text-align: left;
        }

        td.nb {
            font-size: smaller;
        }

        .rec,
        .pr {
            color: #005A9C;
            background-color: #99EE99
        }

        .ext {
            background-color: #FFFFFF
        }

        .cr,
        .lcwd {
            color: #005A9C;
            background-color: #EEEE99
        }

        .wd {
            color: #005A9C;
            background-color: #EE9999
        }

        .ed,
        .fpwd {
            color: #005A9C;
            background-color: #FF7777
        }

        code {
            white-space: pre;
        }

        html {
            background-image: none !important;
        }

        body {
            background: white top left fixed no-repeat !important;
            background-size: 25px auto !important;
            background-image:
                url('https://www.openactive.io/assets/openactive-label-specification.png') !important;
        }

        h1 {
            font-family: 'Open Sans', sans-serif !important;
            font-weight: 300 !important;
            color: #69b9ff !important;
            font-size: 220%;
        }

        #toc {
            padding-top: 0px !important;
        }

        .remove {
            background-colour: yellow;
        }

        code {
            color: #C83500;
        }

        em.rfc2119 {
            font-variant: small-caps;
        }
    </style>

</head>

<body>
    <style>
        body {
            background-size: 25px auto !important;
        }

        body.toc-sidebar #toc {
            background-size: 25px auto !important;
            background-attachment: fixed !important;
        }
    </style>
    <section id='abstract'>
This document specifies an HTTP API for placing bookings to participate in
physical activities, either by attending events or through the use of leisure
or sports facilities.
    </section>

    <section id='sotd'>
Contributions to this document are not only welcomed but are actively solicited
and should be made via
[GitHub Issues](https://github.com/openactive/open-booking-api/issues) and
pull requests. The source code is available
on [GitHub](https://github.com/openactive/open-booking-api).

        <div class="warning">
This document represents an early draft of the planned API design. It is highly
likely to change completely between now and the first published version. These
early drafts are intended to help developers provide feedback by developing
early proof-of-concept implementations.
        </div>

    </section>

    <section class="informative">
# Introduction

The document is an output of the
[OpenActive Community Group](http://www.w3.org/community/openactive/). As part
of the [OpenActive](https://openactive.io) initiative, the community group is
developing standards that will promote the publication and use of open
[opportunity data](https://www.openactive.io/modelling-opportunity-data/#categories-of-physical-activity-data)
in helping people to become more physically active.

The Community Group have already published specifications that define standard
data models ([[!Modelling-Opportunity-Data]]) and support the publication and
harvesting of data in standard formats ([[RPDE]]).

This existing work helps increase the discovery of opportunities for people to
be active. This specification builds on that work by defining an HTTP API that
can be implemented by booking systems that are publishing opportunity data. By
allowing third-party applications to place bookings in their systems, it becomes
 possible for more people to participate in events or make use of leisure and
 sporting facilities.

The specification defines the flow of HTTP requests and responses between the
booking system (server) and the third-party application (client). This includes
definitions of the overall application flow, detailed request and response
formats and the potential error conditions that applications may encounter.

## Scope and requirements

The current scope of the specification should conform to a set of
[use cases and requirements](https://docs.google.com/document/d/1fsCr071V12i_2g0DK818OAGlEAJFLWwkBp9bpgx4fo8/edit?usp=sharing)
that have previously been identified and discussed with the OpenActive
community.

The focus of the initial versions of this specification will be on the simplest
use cases that will support making bookings on behalf of users. This core
functionality includes:

* __Pricing and availability__ – checking the price and current availabilty of
an event or for the use of a facility
* __Leasing__ – temporarily reserving spaces for a user to attend an event or
make use of a facility, whilst placing a booking
* __Booking__ – placing and viewing bookings, and where necessary, confirming
receipt of payment from users

A number of additional requirements that relate to the booking of events and
facilities are currently out of scope:

* creating and managing accounts for users
* more complex pricing options, e.g. membership based pricing
* handling bookings for multiple events ("shopping carts") or for groups of users
* waiting lists for events

It is possible that future versions of this specification may include support
for these or other features. Revisions will be driven by the needs of the
community.

### Functionality that is out of scope

By design this specification will not define some types of functionality.

These have been declared as permanently out of scope because they are either
adequately covered by existing specifications, or will be covered by future
work of the OpenActive Community Group.

The functionality that is currrently defined as out of scope includes:

* __API authentication and security__ – while the specification recommends some
best practices relating to authentication and security it does not mandate a
specific means of securing an API. Implementers are free to choose the system
that offers the best security for their platform and users
* __Payment processing__ – the design assumes that all payment handling will
be carried out by the third-party application, in a separate payment flow.
Booking systems and application developers are able to use the payment and
reconciliation mechanisms that provide the best options for their customers
* __API business models__ – the design is agnostic to any business models that
might govern the use of the API, e.g. revenue-sharing or transaction processing
fees
* __Discovery__  – finding, filtering and searching for opportunity data. This
specification assumes that the client and server applications have already
shared data about the relevant opportunities. Additional functionality in this
area will be addressed by future specifications from the Community Group

## Audience

The document is primarily intended for the following audiences:

* Software developers who want to implement the API, e.g. as part of a booking
system
* Software developers building client libraries or applications that will use
the API

The following sections introduce terminology, concepts and requirements that
underpin the design of the API. This content might also be useful for a wider
audience, e.g. business analysts or product managers looking for a high-level
overview of the API functionality.

    </section>

    <section id="conformance">
This specification makes use of the compact IRI Syntax; please refer to the
[Compact IRIs](http://www.w3.org/TR/json-ld/#compact-iris) from [[JSON-LD]].
    </section>

    <section>
# Typographical Conventions

The following typographic conventions are used in this specification:


        <dl class="typography">
            <dt>`markup`</dt>
            <dd>Markup (elements, attributes, properties), machine processable
                values (string, characters, media types), property name, or a
                file name is in a monospace font.</dd>
            <dt>__*definition*__</dt>
            <dd>A definition of a term, to be used elsewhere in this or other
                specifications, is in bold and italics.</dd>
            <dt>[hyperlink]()</dt>
            <dd>A hyperlink is underlined and in blue.</dd>
            <dt>[[reference]]()</dt>
            <dd>A document reference (normative or informative) is enclosed in
                square brackets and links to the references section.</dd>
        </dl>

        <div class="note">
Notes are in light green boxes with a green left border and with a "Note"
header in green. Notes are normative or informative depending on the whether
they are in a normative or informative section, respectively.

        </div>
        <pre class="example">
Examples are in light khaki boxes, with khaki left border, and with a
numbered "Example" header in khaki. Examples are always informative.
The content of the example is in monospace font and may be syntax colored.
</pre>

    </section>

    <section>
# Key Concepts

        <dl class="typography">
            <dt>__*booking system*__</dt>
            <dd>The platform or service that provides a server-side
            implementation of this API.
            </dd>
            <dt>__*broker*__</dt>
            <dd>The organisation or developer providing an application that
            allows customers to make bookings. Those applications will be
            clients of the API defined in this specification</dd>
            <dt>__*confirmation*__</dt>
            <dd>The process of contacting a customer following the placement
            of a successful order, e.g. to provide tickets, attendance details,
            etc. This specification does not define this process</dd>
            <dt>__*customer*__</dt>
            <dd>The user who places a booking using an application provided by
            a broker.</dd>
            <dt>__*event*__</dt>
            <dd>An [Event](https://www.openactive.io/modelling-opportunity-data/#events)
                is an opportunity to take part in a physical activity. Events
                take place at a specific location and at an agreed date
                and time.</dd>
            <dt>__*facility*__</dt>
            <dd>A sporting facility, e.g. a squash court, table tennis table or
            football pitch.</dd>
            <dt>__*lease*__</dt>
            <dd>A temporary reservation of a space at an event or for the use
            of a facility. Leases provide a limited time window during which
            a customer can place a booking and still be guaranteed a place at
            an event (or use of the facility).</dd>
            <dt>__*offer*__</dt>
            <dd>An [Offer](https://www.openactive.io/modelling-opportunity-data/#offers)
                describes the terms under which a customer may participate in an
                event or use a facility.</dd>
            <dt>__*order*__</dt>
            <dd>Describes the in-process or completed booking. An order may be
            made up of several order items. An order results in a customer
            having a confirmed reservation.</dd>
            <dt>__*payment*__</dt>
            <dd>The process of taking funds from a customer in order to place
            an order. Payment is managed between the customer and the broker.</dd>
            <dt>__*reconciliation*__</dt>
            <dd>The process by which brokers and booking systems confirm that
            payment(s) have been taken on behalf of customers, to ensure that
            money is appropriately exchanged between the brokers, booking systems
            and sellers. This specification does not define this process.</dd>
            <dt>__*refund*__</dt>
            <dd>The process of returning funds to a customer, e.g. if an order
            is cancelled. This specification does not define this process.</dd>
            <dt>__*reservation*__</dt>
            <dd>A reservation for a customer to attend an event or for the use
            of a facility. A reservation is created for every item in an order.</dd>
            <dt>__*seller*__</dt>
            <dd>The organisation providing access to events or use of facilities
            via a booking system. E.g. a leisure provider running yoga classes.</dd>
        </dl>

    </section>

    <section class="normative">
# Booking Flow

## High-level summary of the API

This API defines a means for a **booking system** to expose an HTTP API that
may be used by a **broker** to place bookings on behalf of a **customer**. By
exposing this API the booking system can support a **seller** in reaching a wider
audience.

A broker provides customers with an application that helps them to discover
opportunities to be physically active. The customer may then choose to make
a booking to attend an **event** or to make use of a **facility**.

The broker will check the availability of event or facility in order to check
whether the customer can still attend. The broker will also present the customer
with information about any costs associated with participating in the event
or using a facility. This involves identifying the applicable *offers* and
presenting them to the user.

If there is still availability and the customer is happy to accept an offer,
then the customer can proceed to make a booking. The broker creates
an **order** on behalf of the user.

Creating the order will also create a temporary **lease** that will reserve a
space for the customer to attend the event (or use the facility) while the
rest of the workflow completes.

If the **offers** for an event or use of a facility indicate that the user must
pay, then the broker will take the customer through a separate **payment**
workflow. This workflow is not defined by this specification.

Once payment has been completed, the broker will update the booking platform to
indicate that payment has been taken. The booking process is then completed.

The completion of the order will result in the lease being removed and a
permanent **reservation** being created on behalf of the customer. The customer
may receive **confirmation** from either the broker or booking system (or both)
that provides details about how and when they can attend the event or use the
booked facility.

Separately the broker and booking system will go through a **reconciliation**
process to transfer funds or otherwise report on successful transactions. A
customer might also cancel an order and will then receive a **refund**. Neither
of these processes are defined by this specification. The details will depend on
the business model and agreements in place between the broker and booking system.

## Sequence diagram

        <div class="issue"
             title="Update diagrams to use consistent terminology"
             data-number="37">
        </div>

    <figure>
     <img src="flow-diagram.png" alt="Flow diagram">
     <figcaption>Simple illustration of booking workflow</figcaption>
    </figure>

    <figure>
     <img src="sequence-diagram.png" alt="Sequence diagram">
     <figcaption>Sequence diagram showing API interactions</figcaption>
    </figure>

        <div class="issue"
             title="Add step-by-step process walk-through"
             data-number="36">
        </div>

## Step-by-step process description

1. The **broker** requests details on a specific **event** from the **booking
system** (/events/452 in example) in order to discover available **offers**.
These offers are subsequently presented to the **customer**.
2. The **customer** chooses an bookable **offer** (see definition of a bookable
event).
3. If the **offer** for the **event** is bookable, the broker makes a POST
request to the **orders** endpoint (/orders in the examples) containing a
Person object describing the **customer**. At a minimum, this object should
contain the `email` address for the **customer**, if possible the `givenName`
and `familyName`. The **booking system** creates a timed **lease** on the space
in the **event** which is being booked. At this point the **offer** is deemed to
be accepted and an **order** is created. The **booking system** sends a 201
status code, with a representation of the **order** in the body of the response,
and with a Location header set containing the URI for the web representation of
the created **Order** object.
4. If there is a price for the **offer**, the **broker** takes payment from the
**customer** via a third party payment provider.
5. The **broker** notifies the **seller** of the payment by making a PATCH
request to the specific order endpoint (/orders/789 in the example) of the
**booking system**. This should include details of the `paymentMethod` and the
`paymentMethodId` (commonly the last four digits of the card which can be used
by the **seller** to identify the **customer**). The **broker** should store any
details about the transaction which are needed for processing refunds or in the
case of chargebacks. This is out of scope for the Booking API spec and is the
responsibility of the **broker**.
6. The **booking system** notifies the **broker** of a successful order
completion by returning a response with a 200 status code and an object with an
appropriate value for the `confirmationCode` field.

## Notes and assumptions on step-by-step description

- Assumption: since the **broker** is in control of taking the payment and is the
merchant in the transaction that they should be responsible for storing things
such as authentication codes. This is out of scope for this API.

- Since the schema:Order definition only has support for a `paymentMethodId` and
a `paymontMethod`, multipart payments are not supported in this iteration of <thead>
  Booking API specification as an array of an appropriate payment object would
  need to be appended to the Order object.
</thead>

    </section>

    <section class="normative">
# Common Requirements

This section defines some common functionality that applies to the design of the
whole API.

## Media types

        <div class="issue"
           title="Decide approach towards media type versioning and
           content negotiation" data-number="21">
        This approach is inspired by github approach, should we keep it?
        Should servers be expected to support backwards compatible media types?
        </div>

Custom media types are used in this API to allow clients to choose the format
of the data they receive.

Servers MAY choose to support additional media types but MUST support the
media type(s) defined by this specification.

Media types will conform to the following pattern:

```
application/vnd.openactive[.version]+json
```

The current media type is:

```
application/vnd.openactive.0.5+json
```

## Response formats

Requests and response documents exchanged via this API will all be valid
[[!JSON-LD]] documents.

The documents MUST include a [[!JSON-LD]] `context` that refers to the
[[!OpenActive-Vocabulary]] as follows:

<pre class="example" title="minimal JSON-LD document">
{
  "@context": "https://www.openactive.io/ns/oa.jsonld"
}
</pre>

Unless otherwise specified the request and response documents MUST conform to
the [[!Modelling-Opportunity-Data]] data model.

## Error handling

        <div class="issue"
           title="Decide whether to keep use of RFC7807" data-number="22">
        Requests and responses will be valid JSON-LD except for errors which uses
        [[RFC7807]]. Should we keep this, because its standard or define something
        bespoke?
        </div>

Error responses MUST be served using an appropriate HTTP 4XX status code.

All error responses from this API MUST conform to [[!RFC7807]], and
have media type of `application/problem+json`.

        <pre class="example" title="Error response format">
        {
          "type": "string",
          "title": "string",
          "status": "string",
          "instance": "string",
          "requestId": "string"
        }
        </pre>

* `type` – a URI reference [[!RFC3986]] that identifies the problem type. This
specification encourages that, when dereferenced, it provide human-readable
documentation for the problem type.
When this member is not present, its value is assumed to be "about:blank".
* `title` – a short, human-readable summary of the problem type. It
SHOULD NOT change from occurrence to occurrence of the problem, except for
purposes of localization (e.g., using proactive content negotiation; see
[[RFC7231]], Section 3.4).
* `status`  – the HTTP status code ([[!RFC7231]], Section 6) generated by the
origin server for this occurrence of the problem.
* `instance`  – a URI reference that identifies the specific occurrence of
the problem. It may or may not yield further information if dereferenced.
* `requestId`  – used by technical support for diagnostics purposes.

        <div class="issue"
           title="Define URIs for common errors" data-number="23">
        The specification recommends use of RFC 7807 which suggests that type in
        responses should be a pre-defined URI. We should define and document these.
        </div>

## Security

All HTTP requests and responses SHOULD be secured using SSL.

## Authentication

    <div class="issue" title="More detailed recommendations for auth" data-number="1">
    </div>

All of the API transactions described in this document SHOULD require
authentication.

This standard does not mandate a particular authentication method, but
recommendation is that implementers SHOULD consider using [[OAuth2]] as it is
well-defined, widely supported and can be used in a variety of different
application flows (e.g. via a Javascript web application or between servers).

Where necessary, OpenID Connect ([[OpenIdConnect]]) provides a standard
way of verifying the identity of customer. It is a thin layer that sits
atop OAuth2.

    </section>

    <section>
# Operations

## Checking availability and offers

    <div class="issue"
            title="Write a definition of 'bookable'"
            data-number="12">
        How does a client know which events it can book?
    </div>

This specification assumes that a *broker* has already obtained opportunity
data from a *booking system* that includes descriptions of events, facilities,
etc. For example by harvesting data via an [[RPDE]] feed.

The availability of an event or facility may change at any time.

The offers available to a customer might also change over time.

A booking system that MUST allow a broker to check the current state of events
and/or facilities depending on what decide they expose from their platform.

### Definition of 'bookable'

An **event** is deemed to be 'bookable' if:

- The **event** has not already occurred

- The `eventStatus` of the **event** does not indicate that it has been
cancelled or postponed

- The gender of the **customer** taking up the opportunity is compatible with
the `genderRestriction` of the **event**

- The age of the **customer** taking up the opportunity is compatible with the
`ageRange` of the **event**

- The `remainingAttendeeCapacity` of the **event** is greater than the number
of places required

- The `potentialAction` of the **event** contains one or more appropriate
ReserveAction objects

- There are one or more valid bookable **offers** for the **event**

- The temporary lease on the space in the **event** (defined in
`Beta:anonymousLeaseDuration`) has not expired before the **payment** is taken
by the **broker** and the **seller** is notified by the **broker** that payment
has taken place.

- The **event** contains a deep link to a URL where the user can book the
**event** independently

The above set of restrictions are at the level of the **event** and the data
contained within the content of the API returns.

On a **booking system** level, an **event** is 'bookable', mediated by a
specific **broker**, if that **broker** has machine readable permission to
access the relevant instance of the Booking API provided by the **booking**
system via an API key or similar token.

For the purposes of this specification, the **event** is only bookable if the
data describing the the **event** is published via a **booking system** which
is compliant with and supports the Open Active Booking API.

### Checking availability and offers for an event

To check the availability of an event a broker will issue a GET request to the
URI specified in the `id` of the Event:

        <pre class="example" title="Viewing event availability">
GET /sessions/9209 HTTP/1.1
Host: example.com
Date: Tue, 07 Jun 2018 20:51:35 GMT
Accept: application/vnd.openactive+json
        </pre>

        <pre class="example" title="Event response">
HTTP/1.1 200 OK
Date: Tue, 07 Jun 2018 20:51:36 GMT
Content-Type: application/vnd.openactive+json
Content-Length: ...


{
  "@context": "https://www.openactive.io/ns/oa.jsonld",
  "type": "Event",
  "identifier": 9209,
  "id": "https://example.com/sessions/9209",
  "name": "Speedball",
  "offers": [
    {
      "type": "Offer",
      "identifier": 2134,
      "name": "Speedball winger position",
      "price": "33.00",
      "priceCurrency": "GBP",
      "availabilityStarts": "2014-04-29T12:14:35",
      "availabilityEnds": "2014-04-29T12:14:35",
      "description": "Winger space for Speedball."
    }
  ],
  "beta:anonymousLeaseDuration": "PT15M",
  "eventStatus": "http://schema.org/EventScheduled",
  "maximumAttendeeCapacity": 30,
  "remainingAttendeeCapacity": 20,
  "startDate": "2018-01-27T11:00:00Z",
  "endDate": "2018-01-27T12:00:00Z",
  "duration": "PT1H",
  "location": {
    ...
  }
}
        </pre>

    <div class="issue"
         title="Clarify use of proposed beta:anonymousLeaseDuration property"
         data-number="25">
        How does this inform lease duration?
    </div>

    <div class="issue"
         title="Describe booking workflow for facilities" data-number="26">
       How does this work for facilities?
    </div>

The client may then present the updated availability and suitable offers to
the customer.

    <div class="issue"
            title="Define processing model for selecting an Order"
            data-number="13">
       How does a client select between multiple orders?
    </div>



## Creating and updating orders

Booking systems MUST expose an orders endpoint, e.g. `/orders` to allow brokers
to initiate the booking workflow.

    <div class="issue"
        title="potentialAction" data-number="5">
        How does a client discover the right endpoint?
    </div>

### Discovering the order endpoint

**Booking systems** MUST expose an orders endpoint, e.g. /orders to allow
**brokers** to initiate and enter the **booking** workflow.

To initiate the **booking workflow**, the **booking system** must include a
`potentialAction` field within each **bookable** **event**. The
`potentialAction` field MUST contain one or more objects of type ReserveAction.

These ReserveAction objects must contain a `target` field containing an
EntryPoint object.

The EntryPoint object MUST state the `url` of the orders endpoint, and SHOULD
contain the `encodingType` and the `httpMethod` which must be POST as a new
**order** object will be created on successful invocation.

An example is below:

<pre class="example" title="Example of a potentialAction">

"potentialAction": [
        {
          "type": "ReserveAction",
          "name": "Book",
          "target": {
            "type": "EntryPoint",
            "url": "https://example.com/orders",
            "encodingType": "application/vnd.openactive.v0.5+json",
            "httpMethod": "POST"
          }
        }
      ]
</pre>

### Creating a new order (`/orders`)

A POST request to the `/orders` collection will ask the server to create an
new Order. A time limited lease will be created for the events referenced
in the Order.

        <div class="issue"
            title="Explain why brokers are included in order creation"
            data-number="38">
            e.g. lease durations, default behaviour, etc
        </div>

        <div class="issue"
            title="Clarify use of proposed beta:anonymousLeaseDuration property"
            data-number="25">
            e.g. lease durations, default behaviour, etc
        </div>

        <div class="issue"
            title="Review order pre-condition checks from 0.4"
            data-number="27">
            e.g. verifying user, etc.
        </div>

        <div class="issue"
            title="Can `orderQuantity` have a value other than 1?"
            data-number="40">
            Are we supporting booking multiple places in v1?
        </div>

        <pre class="example" title="Creating an order - request">
POST /orders HTTP/1.1
Host: example.com
Date: Tue, 07 Jun 2018 20:51:35 GMT
Accept: application/vnd.openactive+json

{
  "@context": "https://www.openactive.io/ns/oa.jsonld",
  "type": "Order",
  "customer": "https://example.com/customers/472",
  "broker": {
    "type": "Organization",
    "name": "MyFitnessApp",
    "url": "https://myfitnessapp.example.com"
  },
  "orderedItem": {
    "type": "OrderItem",
    "orderQuantity": 1,
    "customer": "https://example.com/customers/472",
    "acceptedOffer": "https://example.com/sessions/9209",
    "orderedItem": "https://example.com/sessions/9209"
  }
}
        </pre>

If successful the server will response with the location of a newly created
`Order` resource:

        <pre class="example" title="Creating an order - response">
HTTP/1.1 201 Created
Date: Tue, 07 Jun 2018 20:51:36 GMT
Content-Type: application/vnd.openactive+json
Location: /orders/123
        </pre>

### Viewing an order (`/orders/{orderId}`)

To get the latest state of an order, perform a GET request on its URI.

    <pre class="example" title="Viewing an order - request">
GET /orders/535 HTTP/1.1
Host: example.com
Date: Tue, 07 Jun 2018 20:51:35 GMT
Accept: application/vnd.openactive+json
    </pre>

    <pre class="example" title="Viewing an order - response">
HTTP/1.1 200 Created
Date: Tue, 07 Jun 2018 20:51:36 GMT
Content-Type: application/vnd.openactive+json
Content-Length: ...

{
  "type": "Order",
  "id": "https://example.com/orders/535",
  "identifier": 535,
  "orderedItem": [
    {
      "type": "OrderItem",
      "id": "https://example.com/orders/535/orderitems/987",
      "identifier": 987,
      "customer": "https://example.com/customers/472",
      "orderedItem": {
        "type": "OrderItem",
        "orderQuantity": 1,
        "customer": "https://example.com/customers/472",
        "acceptedOffer": "https://example.com/sessions/9209",
        "orderedItem": "https://example.com/sessions/9209"
      },
      "amount": {
        "type": "MonetaryAmount",
        "value": "10.00",
        "currency": "GBP"
      },
      "subTotalPrice": {
        "type": "MonetaryAmount",
        "value": "5.00",
        "currency": "GBP"
      }
    }
  ],
  "orderStatus": "OrderPaymentDue",
  "paymentDueDate": "2018-02-20T11:00:00Z",
  "orderDate": "2018-02-20T11:00:00Z",
  "partOfInvoice": {
    "type": "Invoice",
    "paymentStatus": "PaymentDue",
    "totalPaymentDue": {
      "type": "MonetaryAmount",
      "value": "10.00",
      "currency": "GBP"
    }
  },
  "potentialAction": [
    {
      "type": "PayAction",
      "name": "Pay",
      "target": {
        "type": "EntryPoint",
        "url": "https://example.com/orders/535/payment",
        "encodingType": "application/vnd.openactive.v0.4+json",
        "httpMethod": "POST"
      }
    }
  ]
}
    </pre>

### Deleting an order

A `DELETE` request to an `Order` URI will delete the order.

### Adding further items to an order

A POST to the `orderItems` collection of the order will append a new item.

    <div class="issue"
             title="Rescope to include multi-item orders?"
             data-number="28">
             Shopping cart models were originally out of scope.
    </div>

## Completing an order (`/orders/{orderId}/payments`)

An Order is completed by the client submitting a payment.

    <div class="issue"
             title="Discovery of /payments endpoint"
             data-number="29">
        How does a client find this? E.g. via `potentialAction`?
    </div>

    <div class="issue"
             title="Clarify use of `paymentMethod` when completing an order"
             data-number="30">
            What does `paymentMethod` refer to?
    </div>

    <div class="issue"
             title="Lease timeout behaviour"
             data-number="34">
             What happens when a lease times out?
    </div>

    <div class="issue"
             title="Document order state transitions"
             data-number="35">
             How does an order change state?
    </div>

    <div class="issue"
             title="Are we supporting partial payments?"
             data-number="41">
             Can a broker make multiple payments?
    </div>

    <div class="issue"
             title="POSTing to /order rather than sub-resources"
             data-number="16">
             Should we post to order instead?
    </div>

An order is not considered complete until payment has occurred.

Brokers MUST update the booking system to indicate that payment has been taken.

Once the seller is content with the payments, it then sets the `orderStatus`
property of the `Order` to `OrderDelivered`.

    <pre class="example" title="Completing an order - request">
POST /orders/123/payments HTTP/1.1
Host: example.com
Date: Tue, 07 Jun 2018 20:51:35 GMT
Accept: application/vnd.openactive+json

{
  "type": "Payment",
  "paymentMethod": "https://www.example.com/customers/472/paymentmethods/9765",
  "totalPaidToProvider": {
    "type": "MonetaryAmount",
    "value": "8.00",
    "currency": "GBP"
  },
  "totalPaidByCustomer": {
    "type": "MonetaryAmount",
    "value": "5.00",
    "currency": "GBP"
  }
}
    </pre>

## Viewing customer orders and reservations

A server SHOULD provide endpoints to allow clients to retrieve information
about previously placed orders and reservations.

    <div class="issue"
            title="How and when are customers and reservations created?"
            data-number="31">
        The creation of customers is not described yet
    </div>

### Viewing customer orders (`/customers/{customerId}/orders`)

A GET request to the orders collection associated with a customer will return
a paged list of orders.

    <div class="issue"
             title="List endpoints should return JSON-LD"
             data-number="7">
        Need to update this to ensure spec is consistent
    </div>

        <pre class="example" title="Viewing customer orders - request">
GET /customers/472/orders HTTP/1.1
Host: example.com
Date: Tue, 07 Jun 2018 20:51:35 GMT
Accept: application/vnd.openactive+json
        </pre>

        <pre class="example" title="Viewing customer orders - response">
HTTP/1.1 200 OK
Date: Tue, 07 Jun 2018 20:51:36 GMT
Content-Type: application/vnd.openactive+json
Content-Length: ...


{
  "links": {
    "self": "https://example.com/customers/472/orders",
    "next": "https://example.com/customers/472/orders?next=9210",
    "last": "https://example.com/customers/472/orders?next=20000"
  },
  "data": [
    {
      "type": "Order",
      "id": "https://example.com/orders/535",
      ...
    },
    ...
  ]
}
        </pre>

### Viewing customer reservations (`/customers/{customerId}/reservations`)

A GET request to the reservations collection associated with a customer will return
a paged list of reservations.

    <div class="issue"
             title="List endpoints should return JSON-LD"
             data-number="7">
        Need to update this to ensure spec is consistent
    </div>

    <pre class="example" title="Viewing customer reservations - request">
GET /customers/472/reservations HTTP/1.1
Host: example.com
Date: Tue, 07 Jun 2018 20:51:35 GMT
Accept: application/vnd.openactive+json
    </pre>

    <pre class="example" title="Viewing customer reservations - response">
HTTP/1.1 200 OK
Date: Tue, 07 Jun 2018 20:51:36 GMT
Content-Type: application/vnd.openactive+json
Content-Length: ...


{
  "links": {
    "self": "https://example.com/customers/472/reservations",
    "next": "https://example.com/customers/472/reservations?next=9210",
    "last": "https://example.com/customers/472/reservations?next=20000"
  },
  "data": [
    {
      "@context": "https://www.openactive.io/ns/oa.jsonld",
      "type": "EventReservation",
      "id": "https://www.example.com/customers/472/reservations/9765",
      "underName": "https://example.com/customers/472",
      "reservationStatus": "http://schema.org/ReservationConfirmed",
      "description": "Event successfully booked.",
      "cancelUntil": "2018-03-27T11:18:55.181Z",
      "reservationFor": {
        "type": "Event",
        "identifier": 9209,
        "id": "https://example.com/sessions/9209"
        ...
      },
      ...
    }
    ...
  ]
}
    </pre>



## Events after order completion: confirmations and refunds

Both the broker and booking system may need to take further actions after
completing an order. This section describes some potential interactions.

    <div class="issue"
             title="Document how and when confirmation happens"
             data-number="32">
        Should a broker be informed or be able to check when confirmation has happened?
    </div>

    <div class="issue"
             title="Document any responsibilities and interactions around refunds"
             data-number="33">
        How are refunds handled and who gets notified?
    </div>

    </section>

    <section class='appendix informative'>
# Acknowledgements

The editors thank
[all members](http://www.w3.org/community/openactive/participants) of the
OpenActive Community Group for their contributions.
    </section>
</body>

</html>
